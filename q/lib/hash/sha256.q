/###########
/# SHA-256 #
/###########

/ Secure Hash Algorithm Properties
.sha256.messageSize:64;
.sha256.blockSize:512;
.sha256.wordSize:32;

/ 3.2 Operations on Words
.sha256.addMod32:.sha.addMod2w 32;

/ 4.1.2 SHA-224 and SHA-256 Functions
.sha256.Sigma0:.sha.SigmaN -2 -13 -22;
.sha256.Sigma1:.sha.SigmaN -6 -11 -25;
.sha256.sigma0:.sha.sigmaN -7 -18 3;
.sha256.sigma1:.sha.sigmaN -17 -19 10;

/ 4.2.2 SHA-224 and SHA-256 Constants
/ Constants (first 32 bits of the fractional parts of the cube roots of first 64 prime numbers)
.sha256.K:(
    01000010100010100010111110011000b;01110001001101110100010010010001b;10110101110000001111101111001111b;11101001101101011101101110100101b;
    00111001010101101100001001011011b;01011001111100010001000111110001b;10010010001111111000001010100100b;10101011000111000101111011010101b;
    11011000000001111010101010011000b;00010010100000110101101100000001b;00100100001100011000010110111110b;01010101000011000111110111000011b;
    01110010101111100101110101110100b;10000000110111101011000111111110b;10011011110111000000011010100111b;11000001100110111111000101110100b;
    11100100100110110110100111000001b;11101111101111100100011110000110b;00001111110000011001110111000110b;00100100000011001010000111001100b;
    00101101111010010010110001101111b;01001010011101001000010010101010b;01011100101100001010100111011100b;01110110111110011000100011011010b;
    10011000001111100101000101010010b;10101000001100011100011001101101b;10110000000000110010011111001000b;10111111010110010111111111000111b;
    11000110111000000000101111110011b;11010101101001111001000101000111b;00000110110010100110001101010001b;00010100001010010010100101100111b;
    00100111101101110000101010000101b;00101110000110110010000100111000b;01001101001011000110110111111100b;01010011001110000000110100010011b;
    01100101000010100111001101010100b;01110110011010100000101010111011b;10000001110000101100100100101110b;10010010011100100010110010000101b;
    10100010101111111110100010100001b;10101000000110100110011001001011b;11000010010010111000101101110000b;11000111011011000101000110100011b;
    11010001100100101110100000011001b;11010110100110010000011000100100b;11110100000011100011010110000101b;00010000011010101010000001110000b;
    00011001101001001100000100010110b;00011110001101110110110000001000b;00100111010010000111011101001100b;00110100101100001011110010110101b;
    00111001000111000000110010110011b;01001110110110001010101001001010b;01011011100111001100101001001111b;01101000001011100110111111110011b;
    01110100100011111000001011101110b;01111000101001010110001101101111b;10000100110010000111100000010100b;10001100110001110000001000001000b;
    10010000101111101111111111111010b;10100100010100000110110011101011b;10111110111110011010001111110111b;11000110011100010111100011110010b);

/ 5.3.3 SHA-256
/ Initial Hash Value (first 32 bits of the fractional parts of the square roots of first 8 prime numbers)
.sha256.H:(
    01101010000010011110011001100111b;10111011011001111010111010000101b;00111100011011101111001101110010b;10100101010011111111010100111010b;
    01010001000011100101001001111111b;10011011000001010110100010001100b;00011111100000111101100110101011b;01011011111000001100110100011001b);

// TODO: Update the do loops to use accumulators

.Q.sha256:.sha256.sha256:{
    bits:.sha.preprocess[.sha256.messageSize;.sha256.blockSize;.sha256.wordSize;x];
    / 5.2 Parsing the Message
    blocks:.sha256.blockSize cut bits;
    H:.sha256.H;
    / Process each block
    j:0;
    do[count blocks;
        / Message schedule
        W,:(.sha256.messageSize-count W:.sha256.wordSize cut blocks j)#enlist .sha256.wordSize#0b;
        / Extend the first 16 words into the remaining words
        do[count[W]-i:16;
            W[i]:.sha256.addMod32(W i-16;.sha256.sigma0 W i-15;W i-7;.sha256.sigma1 W i-2);
            i+:1];
        / Compression loop
        (a;b;c;d;e;f;g;h;i):H,0;
        do[.sha256.messageSize;
            T1:.sha256.addMod32(h;.sha256.Sigma1 e;.sha.Ch[e;f;g];.sha256.K i;W i);
            T2:.sha256.addMod32(.sha256.Sigma0 a;.sha.Maj[a;b;c]);
            (h;g;f;e;d;c;b;a):(g;f;e;.sha256.addMod32(d;T1);c;b;a;.sha256.addMod32(T1;T2));
            i+:1];
        / Update hash values
        H:.sha256.addMod32 each flip((a;b;c;d;e;f;g;h);H);
        j+:1];
    raze .bits.numToHex .bits.bitsToNum each H
    };

// TEST:
show"Testing sha256"
\ts:100 r:"098FC40C1BD1142A0ADC3613E087E5D31C0E890D83F3501558E3FF3C4BEA50D4"~.Q.sha256"Lorem Ipsum is simply dummy text of the printing and typesetting industry"
r
